# appveyor.yml
version: 1.0.{build}

# æ„å»ºç¯å¢ƒ
image: Visual Studio 2022

# åªåœ¨è¿™äº›åˆ†æ”¯æ„å»º
branches:
  only:
    - main
    - master

# ç¯å¢ƒå˜é‡
environment:
  RUST_BACKTRACE: 1

# å…‹éš†æ·±åº¦ï¼ˆåŠ å¿«å…‹éš†é€Ÿåº¦ï¼‰
clone_depth: 10

# å®‰è£…é˜¶æ®µ
install:
  # å®‰è£… Rust
  - ps: |
      if (!(Get-Command "rustc" -ErrorAction SilentlyContinue)) {
        Write-Host "Installing Rust..."
        Invoke-WebRequest -Uri "https://win.rustup.rs/" -OutFile "rustup-init.exe"
        .\rustup-init.exe -y --default-host x86_64-pc-windows-msvc --default-toolchain stable
        $env:PATH = "$env:USERPROFILE\.cargo\bin;$env:PATH"
        [Environment]::SetEnvironmentVariable("Path", $env:PATH, "Machine")
      }
  
  # åˆ·æ–°ç¯å¢ƒå˜é‡
  - refreshenv
  
  # å®‰è£… pnpm
  - ps: |
      if (!(Get-Command "pnpm" -ErrorAction SilentlyContinue)) {
        Write-Host "Installing pnpm..."
        Invoke-WebRequest -Uri "https://get.pnpm.io/install.ps1" -UseBasicParsing | Invoke-Expression
        $env:PNPM_HOME = "$env:USERPROFILE\.local\share\pnpm"
        $env:PATH = "$env:PNPM_HOME;$env:PATH"
      }
  
  # éªŒè¯å®‰è£…
  - rustc --version
  - cargo --version
  - pnpm --version

# æ„å»ºå‰
before_build:
  # å®‰è£…å‰ç«¯ä¾èµ–
  - pnpm install --frozen-lockfile

# æ„å»ºè„šæœ¬
build_script:
  # æ„å»º Tauri åº”ç”¨
  - pnpm tauri build

# æµ‹è¯•è„šæœ¬ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
test_script:
  - echo "Skipping tests for now"

# æ„å»ºäº§ç‰©
artifacts:
  # Windows å®‰è£…åŒ…
  - path: 'src-tauri\target\release\bundle\msi\*.msi'
    name: msi-installer
  
  # Windows å¯æ‰§è¡Œæ–‡ä»¶
  - path: 'src-tauri\target\release\bundle\nsis\*.exe'
    name: exe-installer
  
  # å¤‡ç”¨ï¼šæ‰€æœ‰æ„å»ºäº§ç‰©
  - path: 'src-tauri\target\release\bundle\**\*'
    name: all-bundles

# æ„å»ºæˆåŠŸåçš„é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
on_success:
  - ps: Write-Host "Build completed successfully! ğŸ‰"

# æ„å»ºå¤±è´¥åçš„é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
on_failure:
  - ps: Write-Host "Build failed! ğŸ˜"

# ç¼“å­˜ï¼ˆå¯é€‰ï¼ŒåŠ é€Ÿåç»­æ„å»ºï¼‰
cache:
  - '%USERPROFILE%\.cargo\registry'
  - '%USERPROFILE%\.cargo\git'
  - 'node_modules'