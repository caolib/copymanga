version: 1.0.{build}

# æ„å»ºç¯å¢ƒ - ä»… Windows
image: Visual Studio 2022

# åªåœ¨è¿™äº›åˆ†æ”¯æ„å»º
branches:
  only:
    - main
    - master

# è·³è¿‡æ„å»ºæ¡ä»¶ - å¦‚æœæäº¤æ¶ˆæ¯ä¸åŒ…å« "test:" åˆ™è·³è¿‡æ„å»º
skip_commits:
  message: /^(?!.*test:).*/

# ç¯å¢ƒå˜é‡
environment:
  RUST_BACKTRACE: 1
  CI: true # ä¿®å¤ Tauri CI æ£€æµ‹é—®é¢˜

# å…‹éš†æ·±åº¦ï¼ˆåŠ å¿«å…‹éš†é€Ÿåº¦ï¼‰
clone_depth: 10

# å®‰è£…é˜¶æ®µ
install:
  # å®‰è£… Rust
  - ps: |
      if (!(Get-Command "rustc" -ErrorAction SilentlyContinue)) {
        Write-Host "Installing Rust..."
        Invoke-WebRequest -Uri "https://win.rustup.rs/" -OutFile "rustup-init.exe"
        .\rustup-init.exe -y --default-host x86_64-pc-windows-msvc --default-toolchain stable
        # ç›´æ¥è®¾ç½®å½“å‰ä¼šè¯çš„ PATH
        $env:PATH = "$env:USERPROFILE\.cargo\bin;$env:PATH"
      }

  # å®‰è£… pnpm
  - ps: |
      # ç¡®ä¿ Rust åœ¨ PATH ä¸­
      $env:PATH = "$env:USERPROFILE\.cargo\bin;$env:PATH"

      if (!(Get-Command "pnpm" -ErrorAction SilentlyContinue)) {
        Write-Host "Installing pnpm..."
        npm install -g pnpm
      }

  # éªŒè¯å®‰è£…
  - ps: |
      # ç¡®ä¿ PATH æ­£ç¡®è®¾ç½®
      $env:PATH = "$env:USERPROFILE\.cargo\bin;$env:PATH"
      Write-Host "Verifying installations..."
      rustc --version
      cargo --version
      pnpm --version

# æ„å»ºå‰
before_build:
  # ç¡®ä¿ç¯å¢ƒå˜é‡æ­£ç¡®
  - ps: $env:PATH = "$env:USERPROFILE\.cargo\bin;$env:PATH"
  # å®‰è£…å‰ç«¯ä¾èµ–
  - pnpm install --frozen-lockfile

# æ„å»ºè„šæœ¬
build_script:
  # è®¾ç½®æ­£ç¡®çš„ CI ç¯å¢ƒå˜é‡
  - ps: $env:CI = "true"
  # æ„å»º Tauri åº”ç”¨ - åªæ„å»º Windows exe å®‰è£…åŒ…
  - pnpm tauri build --bundles nsis

# æµ‹è¯•è„šæœ¬ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
test_script:
  - echo "Skipping tests for now"

# æ„å»ºäº§ç‰© - åªä¿ç•™ exe å®‰è£…åŒ…
artifacts:
  # Windows exe å®‰è£…åŒ… (NSIS)
  - path: 'src-tauri\target\release\bundle\nsis\*.exe'
    name: windows-exe-installer

# æ„å»ºæˆåŠŸåçš„é€šçŸ¥
on_success:
  - ps: Write-Host "Windows exe installer build completed successfully! ğŸ‰"

# æ„å»ºå¤±è´¥åçš„é€šçŸ¥
on_failure:
  - ps: Write-Host "Build failed! ğŸ˜"

# ç¼“å­˜ï¼ˆåŠ é€Ÿåç»­æ„å»ºï¼‰
cache:
  - '%USERPROFILE%\.cargo\registry'
  - '%USERPROFILE%\.cargo\git'
  - "node_modules"
