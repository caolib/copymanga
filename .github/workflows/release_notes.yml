name: release-notes

on:
  workflow_run:
    workflows: ["publish"]
    types: [completed]
  workflow_dispatch:
    inputs:
      tag:
        description: 'æ ‡ç­¾åç§°'
        required: true
        type: string

jobs:
  update-release-notes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: è·å–æ ‡ç­¾
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG=$(git describe --tags --abbrev=0)
          fi
          echo "TAG=${TAG}" >> $GITHUB_ENV
          
          # æ„å»ºä¸ publish.yml ç›¸åŒçš„æ ‡ç­¾åæ ¼å¼
          RELEASE_TAG="app-${TAG}"
          echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_ENV
          echo "ä½¿ç”¨æ ‡ç­¾: ${TAG}, Releaseæ ‡ç­¾: ${RELEASE_TAG}"
          
      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
        run: |
          PREV=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          if [ -n "$PREV" ]; then
            COMMITS=$(git log ${PREV}..${TAG} --pretty=format:"- [\`%h\`] %s" --reverse)
          else
            COMMITS=$(git log --pretty=format:"- [\`%h\`] %s" --reverse HEAD)
          fi
          
          # è¿‡æ»¤æ— å…³æäº¤
          FILTERED=$(echo "$COMMITS" | grep -v -E "Merge branch|docs:|README" || echo "- ğŸ”§ ä¼˜åŒ–å’Œæ”¹è¿›")
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          {
            echo ""
            echo "## ğŸ“ æ›´æ–°æ—¥å¿—"
            echo ""
            echo "$FILTERED"
            echo ""
            echo "---"
            echo "ğŸ“‹ [æŸ¥çœ‹å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/caolib/copymanga/commits/${TAG})"
          } > release_notes.md
          
          # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          {
            echo "RELEASE_NOTES<<EOF"
            cat release_notes.md
            echo "EOF"
          } >> $GITHUB_ENV
          
      - name: æ›´æ–°å‘å¸ƒè¯´æ˜
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          body: ${{ env.RELEASE_NOTES }}
          append_body: true
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
