name: Release Notes Generator

on:
  # å½“ publish workflow æˆåŠŸå®Œæˆåè‡ªåŠ¨è¿è¡Œ
  workflow_run:
    workflows: ["publish"]
    types:
      - completed
  # ä¹Ÿæ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to generate release notes for (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  generate-release-notes:
    runs-on: ubuntu-latest
    # åªæœ‰å½“ publish workflow æˆåŠŸæ—¶æ‰è¿è¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ä»¥ä¾¿ç”Ÿæˆæäº¤æ—¥å¿—
      
      - name: Extract tag from workflow_run
        if: github.event_name == 'workflow_run'
        id: extract_tag
        run: |
          # ä» workflow_run äº‹ä»¶ä¸­æå– tag
          TAG_REF="${{ github.event.workflow_run.head_branch }}"
          if [[ $TAG_REF =~ ^refs/tags/(.+)$ ]]; then
            TAG="${BASH_REMATCH[1]}"
          else
            # å¦‚æœä¸æ˜¯ tag è§¦å‘ï¼Œå°è¯•ä»æœ€æ–°çš„ tag è·å–
            TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          fi
          
          if [[ -z "$TAG" ]]; then
            echo "æ— æ³•æå–æ ‡ç­¾ï¼Œé€€å‡º"
            exit 1
          fi
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "æå–çš„æ ‡ç­¾: $TAG"
      
      - name: Set tag for manual dispatch
        if: github.event_name == 'workflow_dispatch'
        id: manual_tag
        run: |
          TAG="${{ github.event.inputs.tag }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "æ‰‹åŠ¨æŒ‡å®šçš„æ ‡ç­¾: $TAG"
      
      - name: Generate commit history
        id: commits
        run: |
          # ç¡®å®šä½¿ç”¨å“ªä¸ªæ ‡ç­¾
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ steps.manual_tag.outputs.tag }}"
          else
            TAG="${{ steps.extract_tag.outputs.tag }}"
          fi
          
          echo "ç”Ÿæˆæ ‡ç­¾ $TAG çš„æäº¤å†å²"
          
          # è·å–æ‰€æœ‰æ ‡ç­¾å¹¶æ’åº
          TAGS=($(git tag --sort=-version:refname | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+'))
          
          CURRENT_TAG="$TAG"
          PREVIOUS_TAG=""
          
          # æ‰¾åˆ°å½“å‰æ ‡ç­¾çš„ä¸Šä¸€ä¸ªæ ‡ç­¾
          for i in "${!TAGS[@]}"; do
            if [[ "${TAGS[$i]}" == "$CURRENT_TAG" && $((i + 1)) -lt ${#TAGS[@]} ]]; then
              PREVIOUS_TAG="${TAGS[$((i + 1))]}"
              break
            fi
          done
          
          echo "å½“å‰æ ‡ç­¾: $CURRENT_TAG"
          echo "ä¸Šä¸€ä¸ªæ ‡ç­¾: $PREVIOUS_TAG"
          
          # ç”Ÿæˆæäº¤è®°å½•
          if [[ -n "$PREVIOUS_TAG" ]]; then
            COMMITS=$(git log "$PREVIOUS_TAG..$CURRENT_TAG" --pretty=format:'- [%h] %s' --reverse)
            RANGE="$PREVIOUS_TAG..$CURRENT_TAG"
          else
            COMMITS=$(git log "$CURRENT_TAG" --pretty=format:'- [%h] %s' --reverse)
            RANGE="é¦–æ¬¡å‘å¸ƒ..$CURRENT_TAG"
          fi
          
          # è¿‡æ»¤æ‰åˆå¹¶æäº¤å’Œæ–‡æ¡£æäº¤
          FILTERED_COMMITS=$(echo "$COMMITS" | grep -v -E "(Merge (branch|pull request)|^- \[[a-f0-9]+\] (docs?:|README|\.md))" || true)
          
          COMMIT_COUNT=$(echo "$FILTERED_COMMITS" | wc -l)
          
          # æ„å»ºå‘å¸ƒè¯´æ˜
          RELEASE_NOTES="## ğŸ“‹ æ›´æ–°å†…å®¹

**ç‰ˆæœ¬èŒƒå›´:** $RANGE  
**æäº¤æ•°é‡:** $COMMIT_COUNT

### Commit

$FILTERED_COMMITS

---
ğŸ“‹ [æŸ¥çœ‹å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG...$CURRENT_TAG)"
          
          # è¾“å‡ºåˆ° GitHub Actions
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
      
      - name: Update release with commit history
        uses: softprops/action-gh-release@v1
        with:
          # é‡è¦ï¼šä½¿ç”¨ app-v å‰ç¼€åŒ¹é… publish workflow åˆ›å»ºçš„ release
          tag_name: app-${{ steps.commits.outputs.current_tag }}
          body: |
            ${{ steps.commits.outputs.release_notes }}
          append_body: true
          make_latest: false
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Output summary
        run: |
          echo "âœ… å·²ä¸º release 'app-${{ steps.commits.outputs.current_tag }}' æ·»åŠ æäº¤å†å²" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ æ ‡ç­¾èŒƒå›´: ${{ steps.commits.outputs.previous_tag }}..${{ steps.commits.outputs.current_tag }}" >> $GITHUB_STEP_SUMMARY
