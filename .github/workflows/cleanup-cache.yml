name: "cleanup-cache"

on:
  schedule:
    # æ¯å‘¨æ—¥æ¸…ç†ä¸€æ¬¡ç¼“å­˜
    - cron: "0 0 * * 0"
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Cleanup old caches
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: caches } = await github.rest.actions.getActionsCacheList({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            console.log(`Found ${caches.actions_caches.length} caches`);

            // æŒ‰åˆ›å»ºæ—¶é—´æŽ’åºï¼Œä¿ç•™æœ€æ–°çš„15ä¸ªç¼“å­˜
            const sortedCaches = caches.actions_caches
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            const cachesToKeep = sortedCaches.slice(0, 15);
            const cachesToDelete = sortedCaches.slice(15);

            console.log(`Keeping ${cachesToKeep.length} caches`);
            console.log(`Deleting ${cachesToDelete.length} caches`);

            let deletedCount = 0;
            let deletedSize = 0;

            for (const cache of cachesToDelete) {
              try {
                await github.rest.actions.deleteActionsCacheById({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  cache_id: cache.id
                });
                deletedCount++;
                deletedSize += cache.size_in_bytes;
                console.log(`âœ“ Deleted cache: ${cache.key} (${(cache.size_in_bytes / 1024 / 1024).toFixed(2)} MB)`);
              } catch (error) {
                console.log(`âœ— Failed to delete cache ${cache.key}: ${error.message}`);
                // å¦‚æžœæ˜¯æƒé™é—®é¢˜ï¼Œæä¾›æ›´è¯¦ç»†çš„è¯´æ˜Ž
                if (error.message.includes('Resource not accessible')) {
                  console.log(`  â†’ This may require 'actions: write' permission in the workflow`);
                }
              }
            }

            // æ˜¾ç¤ºå‰©ä½™ç¼“å­˜å¤§å°å’Œåˆ é™¤ç»Ÿè®¡
            const remainingSize = cachesToKeep.reduce((sum, cache) => sum + cache.size_in_bytes, 0);
            console.log(`\nðŸ“Š Summary:`);
            console.log(`  Deleted: ${deletedCount} caches (${(deletedSize / 1024 / 1024 / 1024).toFixed(2)} GB)`);
            console.log(`  Remaining: ${cachesToKeep.length} caches (${(remainingSize / 1024 / 1024 / 1024).toFixed(2)} GB)`);
