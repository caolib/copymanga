# 漫画章节下载功能说明

## 功能概述

本功能实现了漫画章节的本地下载，支持单章节下载和批量下载，下载的文件会保存到应用资源目录下的 `download/manga` 文件夹中。

## 下载路径结构

下载的章节文件按以下目录结构组织：

```
资源目录/download/manga/
├── {漫画UUID}/
│   ├── {分组类型}/
│   │   ├── {章节UUID}/
│   │   │   ├── info.json          # 章节信息文件
│   │   │   ├── 001.jpg            # 第1页图片
│   │   │   ├── 002.jpg            # 第2页图片
│   │   │   └── ...                # 其他页面
│   │   └── ...
│   └── ...
└── ...
```

### 示例路径

以"迷宫干"漫画的默认类型第一章为例：
```
资源目录/download/manga/d9516222-ebd3-11ee-8d06-55b00c27fb36/default/e217af9c-ebd3-11ee-8d06-55b00c27fb36/
├── info.json
├── 001.jpg
├── 002.jpg
└── ...
```

## 功能特性

### 1. 单章节下载
- 在漫画详情页面，每个章节卡片都有下载按钮
- 支持下载进度显示
- 已下载的章节会显示"已下载"标签
- 支持重新下载功能

### 2. 批量下载
- **下载当前页章节**：下载当前分页显示的所有未下载章节
- **下载全部章节**：下载整个漫画的所有章节（暂未实现）
- **下载未下载章节**：只下载当前页面中尚未下载的章节

### 3. 下载状态管理
- 自动检测已下载的章节
- 显示下载进度百分比
- 防重复下载（已下载的章节会跳过）
- 错误处理和重试机制

### 4. 文件管理
- 自动创建目录结构
- 生成章节信息文件（info.json）
- 图片文件按顺序命名（001.jpg, 002.jpg, ...）
- 自动识别图片格式（jpg, png, webp, gif）

## 使用方法

### 下载单个章节
1. 进入漫画详情页面
2. 找到要下载的章节
3. 点击章节卡片下方的"下载"按钮
4. 等待下载完成

### 批量下载
1. 进入漫画详情页面
2. 点击"批量下载"按钮
3. 选择下载选项：
   - 下载当前页章节
   - 下载未下载章节

### 重新下载
1. 找到已下载的章节（显示"已下载"标签）
2. 点击"重新下载"按钮
3. 确认重新下载

## 技术实现

### 核心组件
- `DownloadManager`: 下载管理器，负责文件下载和管理
- `manga.js`: API封装，提供下载相关接口
- `MangaDetailView.vue`: 界面组件，提供下载操作界面

### 权限要求
- 文件系统读写权限（Tauri）
- 网络访问权限（获取图片）
- 资源目录访问权限

### 并发控制
- 最大并发下载数：3个
- 批量下载时自动添加延迟（1秒间隔）
- 避免服务器负载过高

## 注意事项

1. **存储空间**：请确保有足够的磁盘空间存储下载的图片
2. **网络连接**：下载需要稳定的网络连接
3. **服务器限制**：批量下载时会有延迟以避免触发服务器限制
4. **文件覆盖**：重新下载会覆盖已存在的文件
5. **路径长度**：Windows系统注意路径长度限制

## 故障排除

### 下载失败
- 检查网络连接
- 检查磁盘空间
- 重试下载操作

### 文件权限错误
- 确保应用有文件写入权限
- 检查Tauri权限配置

### 路径错误
- 确保资源目录存在且可访问
- 检查路径中的特殊字符

## 未来改进

1. 支持下载全部章节功能
2. 添加下载队列管理
3. 支持暂停/恢复下载
4. 添加下载历史记录
5. 支持自定义下载路径
6. 添加下载完成通知
